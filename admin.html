<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinKing Admin Panel - Game Management Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .coin-animation {
            animation: flip 2s infinite;
        }
        @keyframes flip {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
            100% { transform: rotateY(360deg); }
        }
        .pulse-green {
            animation: pulse-green 2s infinite;
        }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="glass-effect p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <i class="fas fa-crown text-yellow-400 text-4xl mb-4"></i>
                <h2 class="text-2xl font-bold text-white mb-2">Admin Login</h2>
            </div>
            <form id="loginForm">
                <div class="mb-4">
                    <input type="email" id="adminEmail" placeholder="Admin Email" 
                           class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                </div>
                <div class="mb-6">
                    <input type="password" id="adminPassword" placeholder="Password" 
                           class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                </div>
                <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 rounded-lg transition-colors">
                    <i class="fas fa-sign-in-alt mr-2"></i>Login
                </button>
            </form>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div id="adminPanel" class="hidden">
        <!-- Header -->
        <header class="glass-effect p-4 shadow-lg">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <i class="fas fa-crown text-yellow-400 text-3xl mr-3"></i>
                    <h1 class="text-2xl font-bold text-white">CoinKing Admin Panel</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="p-4">
            <!-- Game Control Section -->
            <div class="glass-effect p-6 rounded-2xl mb-8">
                <h3 class="text-white text-xl font-bold mb-4">Game Control</h3>
                
                <!-- AI Control -->
                <div class="mb-6 p-4 bg-white bg-opacity-10 rounded-xl">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-white font-semibold">AI Auto Mode</h4>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="aiAutoToggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-yellow-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500"></div>
                        </label>
                    </div>
                    <div>
                        <label class="text-white font-semibold mb-2 block">Auto Timer (seconds):</label>
                        <input type="number" id="autoTimer" value="60" min="10" max="300" 
                               class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white border border-white border-opacity-30 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                    </div>
                </div>

                <!-- Manual Control -->
                <div class="mb-6 p-4 bg-white bg-opacity-10 rounded-xl">
                    <h4 class="text-white font-semibold mb-4">Manual Control</h4>
                    <div class="flex gap-4 mb-4">
                        <input type="number" id="manualTimer" placeholder="Timer (seconds)" value="60" min="5" max="300" 
                               class="flex-1 p-3 rounded-lg bg-white bg-opacity-20 text-white border border-white border-opacity-30 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                        <button id="startManualBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-bold transition-colors">
                            Start Game
                        </button>
                        <button id="resetGameBtn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-bold transition-colors">
                            Reset
                        </button>
                    </div>
                    <div class="flex gap-4">
                        <button id="headResultBtn" class="bg-yellow-500 hover:bg-yellow-600 text-black px-6 py-3 rounded-lg font-bold transition-colors">
                            Result: HEAD
                        </button>
                        <button id="tailResultBtn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-bold transition-colors">
                            Result: TAIL
                        </button>
                        <button id="burnResultBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg font-bold transition-colors">
                            Burn Coin
                        </button>
                    </div>
                </div>

                <!-- Game Status -->
                <div class="p-4 bg-white bg-opacity-10 rounded-xl">
                    <h4 class="text-white font-semibold mb-2">Game Status</h4>
                    <div class="text-center">
                        <div id="countdownDisplay" class="text-6xl font-bold text-yellow-400 mb-4">00:00</div>
                        <div id="gameStatusText" class="text-white text-lg font-semibold">Waiting to Start</div>
                    </div>
                </div>
            </div>

            <!-- Live Stats -->
            <div class="glass-effect p-6 rounded-2xl">
                <h3 class="text-white text-xl font-bold mb-4">Live Game Stats</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center">
                        <div class="text-yellow-300 font-semibold">Total on Heads</div>
                        <div class="text-2xl font-bold text-yellow-400">₹<span id="totalHeads">0</span></div>
                    </div>
                    <div class="text-center">
                        <div class="text-red-300 font-semibold">Total on Tails</div>
                        <div class="text-2xl font-bold text-red-400">₹<span id="totalTails">0</span></div>
                    </div>
                    <div class="text-center">
                        <div class="text-green-300 font-semibold">Active Players</div>
                        <div class="text-2xl font-bold text-green-400"><span id="totalPlayers">0</span></div>
                    </div>
                    <div class="text-center">
                        <div class="text-blue-300 font-semibold">Total Bets</div>
                        <div class="text-2xl font-bold text-blue-400">₹<span id="totalBets">0</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBolnOupTsxH6haPUWnWv4gJOSiZgp-y30",
            authDomain: "coinking-d5d5e.firebaseapp.com",
            databaseURL: "https://coinking-d5d5e-default-rtdb.firebaseio.com",
            projectId: "coinking-d5d5e",
            storageBucket: "coinking-d5d5e.firebasestorage.app",
            messagingSenderId: "489710882522",
            appId: "1:489710882522:web:9fcecfd5b6ffd3c3d61fe3",
            measurementId: "G-D4HY1RHEWV"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Global Variables
        let gameTimer = null;
        let countdownTime = 0;
        let aiAutoMode = false;
        let autoTimerValue = 60;
        let isGameRunning = false;

        // Initialize Admin Panel
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            setupRealTimeListeners();
        });

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // AI Auto Toggle
            document.getElementById('aiAutoToggle').addEventListener('change', function() {
                aiAutoMode = this.checked;
                if (aiAutoMode) {
                    autoTimerValue = parseInt(document.getElementById('autoTimer').value) || 60;
                    startAIMode();
                } else {
                    stopAIMode();
                }
            });

            // Manual controls
            document.getElementById('startManualBtn').addEventListener('click', startManualGame);
            document.getElementById('resetGameBtn').addEventListener('click', resetGame);
            
            // Result buttons
            document.getElementById('headResultBtn').addEventListener('click', () => setResult('head'));
            document.getElementById('tailResultBtn').addEventListener('click', () => setResult('tail'));
            document.getElementById('burnResultBtn').addEventListener('click', () => setResult('burn'));
        }

        function setupRealTimeListeners() {
            // Listen for betting data
            database.ref('currentRound/bets').on('value', (snapshot) => {
                const bets = snapshot.val() || {};
                updateBettingStats(bets);
            });
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            if (email === 'akky9453226641@gmail.com') {
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                
                await database.ref('adminSession').set({
                    email: email,
                    loginTime: firebase.database.ServerValue.TIMESTAMP,
                    status: 'online'
                });
            } else {
                alert('Invalid admin credentials');
            }
        }

        async function handleLogout() {
            await database.ref('adminSession').remove();
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            stopAIMode();
        }

        async function startAIMode() {
            if (!aiAutoMode) return;
            
            document.getElementById('gameStatusText').textContent = 'AI Mode: Starting Game...';
            await startGameRound(autoTimerValue);
        }

        function stopAIMode() {
            aiAutoMode = false;
            if (gameTimer) {
                clearInterval(gameTimer);
                gameTimer = null;
            }
            document.getElementById('gameStatusText').textContent = 'AI Mode Disabled';
        }

        async function startManualGame() {
            const timerValue = parseInt(document.getElementById('manualTimer').value) || 60;
            await startGameRound(timerValue);
        }

        async function startGameRound(timerValue) {
            if (isGameRunning) return;
            
            isGameRunning = true;
            countdownTime = timerValue;
            
            // Start new round
            await database.ref('currentRound').set({
                status: 'betting',
                timeLeft: countdownTime,
                startTime: firebase.database.ServerValue.TIMESTAMP,
                bets: {},
                totalAmount: 0
            });

            // Start countdown
            startCountdown();
        }

        function startCountdown() {
            document.getElementById('gameStatusText').textContent = 'Betting Active';
            
            gameTimer = setInterval(async () => {
                countdownTime--;
                updateCountdownDisplay();
                
                // Update Firebase
                await database.ref('currentRound/timeLeft').set(countdownTime);
                
                if (countdownTime <= 0) {
                    clearInterval(gameTimer);
                    gameTimer = null;
                    await endBettingPhase();
                }
            }, 1000);
        }

        function updateCountdownDisplay() {
            const minutes = Math.floor(countdownTime / 60);
            const seconds = countdownTime % 60;
            document.getElementById('countdownDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        async function endBettingPhase() {
            await database.ref('currentRound/status').set('waiting_result');
            document.getElementById('gameStatusText').textContent = 'Processing Result...';
            
            // Get betting data and determine result
            const betsSnapshot = await database.ref('currentRound/bets').once('value');
            const bets = betsSnapshot.val() || {};
            
            let headAmount = 0;
            let tailAmount = 0;
            
            Object.values(bets).forEach(bet => {
                if (bet.choice === 'head') headAmount += bet.amount;
                if (bet.choice === 'tail') tailAmount += bet.amount;
            });

            // AI Logic: Lower bet wins, equal bets = burn
            let result;
            if (headAmount < tailAmount) {
                result = 'head';
            } else if (tailAmount < headAmount) {
                result = 'tail';
            } else {
                result = 'burn';
            }

            // Set result
            await setResult(result);
        }

        async function setResult(result) {
            await database.ref('currentRound').update({
                result: result,
                status: 'finished',
                timeLeft: 0
            });

            document.getElementById('gameStatusText').textContent = `Result: ${result.toUpperCase()}`;

            // Process bets and update wallets instantly
            await processBetsInstantly(result);
            
            // Show result for 3 seconds, then start next round if AI mode
            setTimeout(async () => {
                await database.ref('currentRound').remove();
                isGameRunning = false;
                
                if (aiAutoMode) {
                    // Start next round automatically
                    setTimeout(() => {
                        startAIMode();
                    }, 1000);
                } else {
                    document.getElementById('gameStatusText').textContent = 'Waiting for Next Round';
                    document.getElementById('countdownDisplay').textContent = '00:00';
                }
            }, 3000);
        }

        async function processBetsInstantly(result) {
            const betsRef = await database.ref('currentRound/bets').once('value');
            const bets = betsRef.val() || {};

            // Process all bets simultaneously for instant wallet updates
            const updatePromises = [];

            for (const [userId, bet] of Object.entries(bets)) {
                const userRef = database.ref('users/' + userId);
                
                // Get current user data
                const userSnapshot = await userRef.once('value');
                const userData = userSnapshot.val();

                let walletUpdate = {};

                if (result === 'burn') {
                    // Return original bet amount
                    walletUpdate.wallet = userData.wallet + bet.amount;
                } else if (bet.choice === result) {
                    // Winner gets 2x
                    const winAmount = bet.amount * 2;
                    walletUpdate.wallet = userData.wallet + winAmount;
                    walletUpdate.totalProfit = (userData.totalProfit || 0) + bet.amount;
                } else {
                    // Loser - money already deducted, just update loss
                    walletUpdate.totalLoss = (userData.totalLoss || 0) + bet.amount;
                }

                // Add to update promises for instant execution
                updatePromises.push(userRef.update(walletUpdate));
            }

            // Execute all wallet updates instantly
            await Promise.all(updatePromises);
        }

        async function resetGame() {
            stopAIMode();
            await database.ref('currentRound').remove();
            isGameRunning = false;
            countdownTime = 0;
            document.getElementById('countdownDisplay').textContent = '00:00';
            document.getElementById('gameStatusText').textContent = 'Game Reset';
            
            if (gameTimer) {
                clearInterval(gameTimer);
                gameTimer = null;
            }
        }

        function updateBettingStats(bets) {
            let totalHeads = 0, totalTails = 0, totalPlayers = 0;
            
            Object.values(bets).forEach(bet => {
                totalPlayers++;
                if (bet.choice === 'head') totalHeads += bet.amount;
                if (bet.choice === 'tail') tailAmount += bet.amount;
            });

            document.getElementById('totalHeads').textContent = totalHeads;
            document.getElementById('totalTails').textContent = totalTails;
            document.getElementById('totalPlayers').textContent = totalPlayers;
            document.getElementById('totalBets').textContent = totalHeads + totalTails;
        }
    </script>
</body>
</html>

