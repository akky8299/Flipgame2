<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel - CoinFlip</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { background: #121212; color: white; }
    .container { max-width: 1200px; margin: auto; padding: 20px; }
    h1, h2 { text-align: center; margin: 20px 0; color: #00ccff; }
    button { padding: 10px 15px; margin: 5px; border: none; border-radius: 6px; cursor: pointer; }
    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-warning { background: #ffc107; color: black; }
    input, select { padding: 10px; margin: 10px; border-radius: 6px; border: 1px solid #444; width: 200px; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #444; }
    th { background: #222; }
    .card { background: #1e1e2f; padding: 20px; margin: 20px 0; border-radius: 10px; }
    .login { text-align: center; margin-top: 100px; }
    .countdown { font-size: 24px; color: #ffc107; margin: 10px; }
    .ai-status { color: #0f0; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="adminTitle">एडमिन पैनल</h1>

    <!-- Login Screen -->
    <div id="loginScreen" class="login">
      <h2>एडमिन के रूप में साइन इन करें</h2>
      <button id="adminLogin" class="btn-primary">Google से लॉगिन करें</button>
      <p id="loginStatus">केवल अधिकृत एडमिन को प्रवेश अनुमति है</p>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" style="display:none;">
      <div class="card">
        <h2 id="countdownTitle">उलटी गिनती सेट करें (सेकंड में)</h2>
        <input type="number" id="countdownInput" placeholder="उदा. 60" value="60" />
        <button id="startCountdown" class="btn-primary">बेट शुरू करें</button>
        <button id="resetBets" class="btn-warning">बेट रीसेट करें</button>
        <div class="countdown" id="countdownDisplay">अगला राउंड: --</div>
      </div>

      <div class="card">
        <h2 id="bossTitle">बॉस प्रबंधन</h2>
        <input type="text" id="bossName" placeholder="बॉस का नाम" />
        <input type="text" id="bossRefId" placeholder="रेफरल आईडी" />
        <button id="addBoss" class="btn-success">बॉस जोड़ें</button>
        <select id="bossList">
          <option value="">बॉस चुनें</option>
        </select>
        <button id="removeBoss" class="btn-danger">हटाएं</button>
      </div>

      <div class="card">
        <h2 id="liveTitle">लाइव बेटिंग डेटा</h2>
        <table id="liveTable">
          <tr>
            <th>चित (Heads)</th>
            <td id="headsAmount">₹0</td>
          </tr>
          <tr>
            <th>पट (Tails)</th>
            <td id="tailsAmount">₹0</td>
          </tr>
          <tr>
            <th>कुल बेट</th>
            <td id="totalBet">₹0</td>
          </tr>
          <tr>
            <th>कुल यूजर</th>
            <td id="totalUsers">0</td>
          </tr>
        </table>
      </div>

      <div class="card">
        <h2 id="resultTitle">रिजल्ट दें</h2>
        <button id="resultHeads" class="btn-primary">चित</button>
        <button id="resultTails" class="btn-warning">पट</button>
        <button id="resultBurn" class="btn-danger">जल गया (Burn)</button>
        <p id="aiSuggestion" class="ai-status">AI: रुकें...</p>
      </div>

      <div class="card">
        <h2 id="requestsTitle">लेन-देन अनुरोध</h2>
        <table id="requestsTable">
          <thead>
            <tr>
              <th>यूजर UID</th>
              <th>राशि</th>
              <th>प्रकार</th>
              <th>स्थिति</th>
              <th>कार्य</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <button id="logoutBtn" class="btn-danger">लॉग आउट</button>
    </div>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAWFRw8XzqGF011OdzRO8WzaXcCF5Uzsxg",
      authDomain: "flipcoin-1030e.firebaseapp.com",
      databaseURL: "https://flipcoin-1030e-default-rtdb.firebaseio.com",
      projectId: "flipcoin-1030e",
      storageBucket: "flipcoin-1030e.firebasestorage.app",
      messagingSenderId: "485574721435",
      appId: "1:485574721435:web:9c4713a57521128f122b3e",
      measurementId: "G-JKG0KTMTBQ"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const ADMIN_EMAIL = "akky9453226641@gmail.com";

    // Language
    let lang = 'hi';
    const t = {
      hi: {
        adminTitle: "एडमिन पैनल",
        countdownTitle: "उलटी गिनती सेट करें (सेकंड में)",
        bossTitle: "बॉस प्रबंधन",
        liveTitle: "लाइव बेटिंग डेटा",
        resultTitle: "रिजल्ट दें",
        requestsTitle: "लेन-देन अनुरोध"
      },
      en: {
        adminTitle: "Admin Panel",
        countdownTitle: "Set Countdown (seconds)",
        bossTitle: "Boss Management",
        liveTitle: "Live Betting Data",
        resultTitle: "Declare Result",
        requestsTitle: "Transaction Requests"
      }
    };

    function updateLang() {
      document.getElementById("adminTitle").textContent = t[lang].adminTitle;
      document.getElementById("countdownTitle").textContent = t[lang].countdownTitle;
      document.getElementById("bossTitle").textContent = t[lang].bossTitle;
      document.getElementById("liveTitle").textContent = t[lang].liveTitle;
      document.getElementById("resultTitle").textContent = t[lang].resultTitle;
      document.getElementById("requestsTitle").textContent = t[lang].requestsTitle;
    }

    // Admin Login
    document.getElementById("adminLogin").onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    };

    auth.onAuthStateChanged(user => {
      if (user && user.email === ADMIN_EMAIL) {
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("adminPanel").style.display = "block";
        loadBosses();
        loadRequests();
        setupRealtimeData();
        updateLang();
      } else {
        document.getElementById("loginScreen").style.display = "block";
        document.getElementById("adminPanel").style.display = "none";
      }
    });

    document.getElementById("logoutBtn").onclick = () => {
      auth.signOut();
    };

    // Load Bosses
    function loadBosses() {
      const select = document.getElementById("bossList");
      db.ref("bosses/").on("value", snap => {
        select.innerHTML = "<option value=''>बॉस चुनें</option>";
        snap.forEach(child => {
          const opt = document.createElement("option");
          opt.value = child.key;
          opt.textContent = child.val().name;
          select.appendChild(opt);
        });
      });
    }

    document.getElementById("addBoss").onclick = () => {
      const name = document.getElementById("bossName").value.trim();
      const refId = document.getElementById("bossRefId").value.trim();
      if (!name || !refId) {
        alert("नाम और रेफरल आईडी दर्ज करें");
        return;
      }
      db.ref("bosses/").push({ name, refId });
      document.getElementById("bossName").value = "";
      document.getElementById("bossRefId").value = "";
    };

    document.getElementById("removeBoss").onclick = () => {
      const key = document.getElementById("bossList").value;
      if (key) {
        db.ref("bosses/" + key).remove();
        alert("बॉस हटाया गया");
      }
    };

    // Countdown
    document.getElementById("startCountdown").onclick = () => {
      const seconds = parseInt(document.getElementById("countdownInput").value);
      if (isNaN(seconds) || seconds < 10) {
        alert("कम से कम 10 सेकंड");
        return;
      }
      db.ref("game/currentCountdown").set(seconds);
      setTimeout(() => {
        db.ref("game/currentCountdown").set(null);
      }, seconds * 1000);
    };

    document.getElementById("resetBets").onclick = () => {
      db.ref("bets").remove();
      alert("सभी बेट रीसेट");
    };

    // Realtime Betting Data
    function setupRealtimeData() {
      db.ref("game/currentCountdown").on("value", s => {
        const val = s.val();
        document.getElementById("countdownDisplay").textContent = val ? `अगला राउंड: ${val} सेकंड` : "राउंड समाप्त";
      });

      db.ref("bets").on("value", snap => {
        let heads = 0, tails = 0, users = 0;
        snap.forEach(child => {
          const bet = child.val();
          if (bet.choice === "heads") heads += bet.amount;
          else if (bet.choice === "tails") tails += bet.amount;
          users++;
        });
        const total = heads + tails;
        document.getElementById("headsAmount").textContent = `₹${heads}`;
        document.getElementById("tailsAmount").textContent = `₹${tails}`;
        document.getElementById("totalBet").textContent = `₹${total}`;
        document.getElementById("totalUsers").textContent = users;

        // AI Suggestion via Gemini
        suggestResult(heads, tails);
      });
    }

    // Gemini AI Integration
    async function suggestResult(heads, tails) {
      const API_KEY = "AIzaSyDkRBSjzlCQ98BkuI37uQh_7ntHgVgMk6E";
      const prompt = `In a coin flip game:
        Heads bet: ₹${heads}
        Tails bet: ₹${tails}
        If equal, suggest 'burn'. Otherwise, suggest the side with less bet to win for profit balance.
        Reply only: heads, tails, or burn.`;

      try {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=${API_KEY}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        const data = await res.json();
        const aiResult = data?.candidates?.[0]?.content?.parts?.[0]?.text?.trim().toLowerCase();
        document.getElementById("aiSuggestion").textContent = `AI: ${aiResult}`;
      } catch (e) {
        document.getElementById("aiSuggestion").textContent = "AI: त्रुटि";
      }
    }

    // Result Buttons
    ["Heads", "Tails", "Burn"].forEach(type => {
      document.getElementById(`result${type}`).onclick = () => {
        const result = type.toLowerCase() === "burn" ? "burn" : type.toLowerCase();
        db.ref("game/lastResult").set(result);

        if (result !== "burn") {
          db.ref("bets").once("value").then(snap => {
            snap.forEach(child => {
              const bet = child.val();
              const win = (result === "heads" && bet.choice === "heads") || (result === "tails" && bet.choice === "tails");
              if (win) {
                db.ref("users/" + bet.uid + "/balance").transaction(current => (current || 0) + bet.amount * 2);
                db.ref("users/" + bet.uid).update({ totalProfit: firebase.database.ServerValue.increment(bet.amount) });
              } else {
                db.ref("users/" + bet.uid).update({ totalLoss: firebase.database.ServerValue.increment(bet.amount) });
              }
            });
          });
        } else {
          // No profit no loss
        }

        // Reset bets after result
        setTimeout(() => {
          db.ref("bets").remove();
        }, 2000);
      };
    });

    // Requests
    function loadRequests() {
      db.ref("requests").on("value", snap => {
        const tbody = document.querySelector("#requestsTable tbody");
        tbody.innerHTML = "";
        snap.forEach(child => {
          const req = child.val();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${req.uid}</td>
            <td>₹${req.amount}</td>
            <td>${req.type}</td>
            <td>${req.status}</td>
            <td>
              <button class="btn-success approve" data-key="${child.key}" data-uid="${req.uid}" data-amount="${req.amount}" data-type="${req.type}">मंजूर</button>
              <button class="btn-danger reject" data-key="${child.key}">अस्वीकार</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        // Approve/Reject
        document.querySelectorAll(".approve").forEach(btn => {
          btn.onclick = function () {
            const key = this.getAttribute("data-key");
            const uid = this.getAttribute("data-uid");
            const amount = parseInt(this.getAttribute("data-amount"));
            const type = this.getAttribute("data-type");

            if (type === "add") {
              db.ref("users/" + uid + "/balance").transaction(current => (current || 0) + amount);
            } else if (type === "withdraw") {
              db.ref("users/" + uid + "/balance").transaction(current => {
                return (current || 0) >= amount ? current - amount : current;
              });
            }

            db.ref("requests/" + key).update({ status: "approved" });
            alert("अनुरोध मंजूर");
          };
        });

        document.querySelectorAll(".reject").forEach(btn => {
          btn.onclick = function () {
            const key = this.getAttribute("data-key");
            db.ref("requests/" + key).update({ status: "rejected" });
          };
        });
      });
    }
  </script>
</body>
</html>
