<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinKing Admin Panel - Enhanced AI System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        .chart-container {
            height: 400px;
            width: 100%;
        }
        .live-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .coin-flip {
            animation: flip 1s linear;
        }
        @keyframes flip {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .auto-mode-active {
            background: linear-gradient(45deg, #ef4444, #dc2626) !important;
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }
            50% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.8); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- Notification -->
    <div id="notification" class="notification">
        <div class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="notificationText">Success!</span>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center gradient-bg">
        <div class="glass-effect rounded-xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <i class="fas fa-coins text-6xl text-yellow-400 mb-4"></i>
                <h1 class="text-3xl font-bold text-white mb-2">CoinKing Admin</h1>
                <p class="text-gray-300">Enhanced AI Control Panel</p>
            </div>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                    <input type="email" id="adminEmail" class="w-full px-4 py-3 bg-gray-800 rounded-lg border border-gray-600 focus:border-yellow-400 focus:outline-none text-white" placeholder="Enter admin email" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                    <input type="password" id="adminPassword" class="w-full px-4 py-3 bg-gray-800 rounded-lg border border-gray-600 focus:border-yellow-400 focus:outline-none text-white" placeholder="Enter password" required>
                </div>
                <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-4 rounded-lg transition duration-200">
                    <i class="fas fa-sign-in-alt mr-2"></i>Login to Admin Panel
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
        <!-- Header -->
        <header class="bg-gray-800 shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div class="flex items-center">
                        <i class="fas fa-coins text-3xl text-yellow-400 mr-3"></i>
                        <h1 class="text-2xl font-bold text-white">CoinKing Admin Panel</h1>
                        <div id="aiStatusIndicator" class="ml-4 hidden">
                            <span class="bg-red-500 text-white px-3 py-1 rounded-full text-sm font-semibold animate-pulse">
                                <i class="fas fa-robot mr-1"></i>AI ACTIVE
                            </span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="live-indicator flex items-center">
                            <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                            <span class="text-sm text-gray-300">LIVE</span>
                        </div>
                        <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Stats -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gray-800 rounded-xl p-6 glass-effect">
                    <div class="flex items-center">
                        <div class="bg-blue-500 p-3 rounded-full">
                            <i class="fas fa-users text-xl text-white"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-400 text-sm">Total Users</p>
                            <p id="totalUsers" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-xl p-6 glass-effect">
                    <div class="flex items-center">
                        <div class="bg-green-500 p-3 rounded-full">
                            <i class="fas fa-user-tie text-xl text-white"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-400 text-sm">Total Bosses</p>
                            <p id="totalBosses" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-xl p-6 glass-effect">
                    <div class="flex items-center">
                        <div class="bg-yellow-500 p-3 rounded-full">
                            <i class="fas fa-coins text-xl text-white"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-400 text-sm">Active Bets</p>
                            <p id="activeBets" class="text-2xl font-bold">â‚¹0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-xl p-6 glass-effect">
                    <div class="flex items-center">
                        <div class="bg-purple-500 p-3 rounded-full">
                            <i class="fas fa-clock text-xl text-white"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-400 text-sm">Game Status</p>
                            <p id="gameStatus" class="text-lg font-bold text-green-400">Ready</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Tabs -->
            <div class="mb-6">
                <nav class="flex space-x-8" aria-label="Tabs">
                    <button onclick="showTab('game-control')" class="tab-btn bg-yellow-600 text-white px-6 py-3 rounded-t-lg font-medium">
                        <i class="fas fa-gamepad mr-2"></i>Game Control
                    </button>
                    <button onclick="showTab('boss-management')" class="tab-btn bg-gray-700 text-gray-300 px-6 py-3 rounded-t-lg font-medium">
                        <i class="fas fa-user-tie mr-2"></i>Boss Management
                    </button>
                    <button onclick="showTab('live-stats')" class="tab-btn bg-gray-700 text-gray-300 px-6 py-3 rounded-t-lg font-medium">
                        <i class="fas fa-chart-line mr-2"></i>Game History
                    </button>
                    <button onclick="showTab('wallet-requests')" class="tab-btn bg-gray-700 text-gray-300 px-6 py-3 rounded-t-lg font-medium">
                        <i class="fas fa-wallet mr-2"></i>Wallet Requests
                    </button>
                </nav>
            </div>

            <!-- Game Control Tab -->
            <div id="game-control-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Game Control Panel -->
                    <div class="bg-gray-800 rounded-xl p-6 glass-effect">
                        <h2 class="text-xl font-bold mb-6">Game Control Panel</h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Set Timer (seconds)</label>
                                <input type="number" id="gameTimer" class="w-full px-4 py-2 bg-gray-700 rounded-lg border border-gray-600 focus:border-yellow-400 focus:outline-none text-white" placeholder="60" min="10" max="300" value="60">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="startBetting()" id="startBettingBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">
                                    <i class="fas fa-play mr-2"></i>Start Betting
                                </button>
                                <button onclick="resetGame()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg">
                                    <i class="fas fa-redo mr-2"></i>Reset Game
                                </button>
                            </div>
                            
                            <div class="text-center py-4">
                                <div id="countdownDisplay" class="text-4xl font-bold text-yellow-400 mb-4">00:00</div>
                                <div id="gamePhase" class="text-lg text-gray-300">Waiting to Start</div>
                            </div>
                            
                            <div class="border-t border-gray-600 pt-4">
                                <h3 class="text-lg font-semibold mb-4">Set Result (Manual)</h3>
                                <div class="grid grid-cols-3 gap-4">
                                    <button onclick="setResult('heads')" id="manualHeadsBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                                        <i class="fas fa-trophy mr-2"></i>Heads
                                    </button>
                                    <button onclick="setResult('tails')" id="manualTailsBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg">
                                        <i class="fas fa-star mr-2"></i>Tails
                                    </button>
                                    <button onclick="setResult('burn')" id="manualBurnBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg">
                                        <i class="fas fa-fire mr-2"></i>Burn Coin
                                    </button>
                                </div>
                            </div>

                            <div class="border-t border-gray-600 pt-4">
                                <h3 class="text-lg font-semibold mb-4">Enhanced AI Auto Control</h3>
                                <p class="text-sm text-gray-400 mb-4">AI will automatically start countdown, decide results (higher bet amount loses), show results for 3 seconds, then restart continuously.</p>
                                <button onclick="toggleAutoMode()" id="autoModeBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-all">
                                    <i class="fas fa-robot mr-2"></i>Enable Auto Mode
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Current Betting Data -->
                    <div class="bg-gray-800 rounded-xl p-6 glass-effect">
                        <h2 class="text-xl font-bold mb-6">Current Game Data</h2>
                        
                        <div class="space-y-6">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-blue-700 rounded-lg p-4 text-center">
                                    <i class="fas fa-trophy text-3xl mb-2"></i>
                                    <p class="text-sm text-gray-300">Heads Bets</p>
                                    <p id="headBetsAmount" class="text-2xl font-bold">â‚¹0</p>
                                    <p id="headBetsCount" class="text-sm text-gray-400">0 users</p>
                                </div>
                                <div class="bg-purple-700 rounded-lg p-4 text-center">
                                    <i class="fas fa-star text-3xl mb-2"></i>
                                    <p class="text-sm text-gray-300">Tails Bets</p>
                                    <p id="tailBetsAmount" class="text-2xl font-bold">â‚¹0</p>
                                    <p id="tailBetsCount" class="text-sm text-gray-400">0 users</p>
                                </div>
                            </div>
                            
                            <div class="bg-gray-700 rounded-lg p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-gray-300">Total Bet Amount</span>
                                    <span id="totalBetAmount" class="text-xl font-bold text-yellow-400">â‚¹0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-300">Active Players</span>
                                    <span id="totalActiveUsers" class="text-xl font-bold text-green-400">0</span>
                                </div>
                            </div>

                            <div class="chart-container">
                                <canvas id="liveChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Boss Management Tab -->
            <div id="boss-management-tab" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Add/Edit Boss -->
                    <div class="bg-gray-800 rounded-xl p-6 glass-effect">
                        <h2 class="text-xl font-bold mb-6">Boss Management</h2>
                        
                        <form id="bossForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Boss Name</label>
                                <input type="text" id="bossName" class="w-full px-4 py-2 bg-gray-700 rounded-lg border border-gray-600 focus:border-yellow-400 focus:outline-none text-white" placeholder="Enter boss name" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Referral ID</label>
                                <input type="text" id="bossReferralId" class="w-full px-4 py-2 bg-gray-700 rounded-lg border border-gray-600 focus:border-yellow-400 focus:outline-none text-white" placeholder="Enter referral ID" required>
                            </div>
                            
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">
                                <i class="fas fa-plus mr-2"></i>Add Boss
                            </button>
                        </form>
                    </div>

                    <!-- Boss List -->
                    <div class="bg-gray-800 rounded-xl p-6 glass-effect">
                        <h2 class="text-xl font-bold mb-6">Boss List</h2>
                        <div id="bossList" class="space-y-4">
                            <!-- Boss list will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Boss Users -->
                <div class="mt-8 bg-gray-800 rounded-xl p-6 glass-effect">
                    <h2 class="text-xl font-bold mb-6">Boss Users</h2>
                    <div class="mb-4">
                        <select id="bossSelect" class="px-4 py-2 bg-gray-700 rounded-lg border border-gray-600 focus:border-yellow-400 focus:outline-none text-white">
                            <option value="">Select a boss</option>
                        </select>
                    </div>
                    <div id="bossUsersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Boss users will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Game History Tab -->
            <div id="live-stats-tab" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-gray-800 rounded-xl p-6 glass-effect">
                        <h2 class="text-xl font-bold mb-6">Game History</h2>
                        <div id="gameHistory" class="space-y-4 max-h-96 overflow-y-auto">
                            <!-- Game history will be populated here -->
                        </div>
                    </div>

                    <div class="bg-gray-800 rounded-xl p-6 glass-effect">
                        <h2 class="text-xl font-bold mb-6">User Statistics</h2>
                        <div class="chart-container">
                            <canvas id="userStatsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wallet Requests Tab -->
            <div id="wallet-requests-tab" class="tab-content hidden">
                <div class="bg-gray-800 rounded-xl p-6 glass-effect">
                    <h2 class="text-xl font-bold mb-6">Wallet Requests</h2>
                    <div id="walletRequestsList" class="space-y-4">
                        <!-- Wallet requests will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBolnOupTsxH6haPUWnWv4gJOSiZgp-y30",
            authDomain: "coinking-d5d5e.firebaseapp.com",
            databaseURL: "https://coinking-d5d5e-default-rtdb.firebaseio.com",
            projectId: "coinking-d5d5e",
            storageBucket: "coinking-d5d5e.firebasestorage.app",
            messagingSenderId: "489710882522",
            appId: "1:489710882522:web:9fcecfd5b6ffd3c3d61fe3",
            measurementId: "G-D4HY1RHEWV"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Global variables
        let countdownInterval = null;
        let currentGameId = null;
        let autoModeEnabled = false;
        let liveChart = null;
        let userStatsChart = null;
        let autoModeTimeout = null;

        // Initialize admin panel
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Boss form
            document.getElementById('bossForm').addEventListener('submit', handleBossSubmit);
            
            // Boss select
            document.getElementById('bossSelect').addEventListener('change', handleBossSelect);
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            const notificationDiv = notification.firstElementChild;
            
            notificationText.textContent = message;
            
            if (type === 'success') {
                notificationDiv.className = 'bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg';
                notificationDiv.innerHTML = '<i class="fas fa-check-circle mr-2"></i><span>' + message + '</span>';
            } else if (type === 'error') {
                notificationDiv.className = 'bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg';
                notificationDiv.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i><span>' + message + '</span>';
            } else if (type === 'warning') {
                notificationDiv.className = 'bg-yellow-500 text-white px-6 py-3 rounded-lg shadow-lg';
                notificationDiv.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i><span>' + message + '</span>';
            }
            
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Authentication Functions
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;

            // Check if admin email
            if (email !== 'akky9453226641@gmail.com') {
                showNotification('Unauthorized access!', 'error');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                // If user doesn't exist, create account
                if (error.code === 'auth/user-not-found') {
                    try {
                        await auth.createUserWithEmailAndPassword(email, password);
                        showNotification('Admin account created successfully!', 'success');
                    } catch (createError) {
                        showNotification('Error: ' + createError.message, 'error');
                    }
                } else {
                    showNotification('Error: ' + error.message, 'error');
                }
            }
        }

        // Auth State Observer
        auth.onAuthStateChanged((user) => {
            if (user && user.email === 'akky9453226641@gmail.com') {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                initializeCharts();
                loadDashboardData();
                startRealTimeUpdates();
                loadBossList();
                loadWalletRequests();
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('adminDashboard').classList.add('hidden');
            }
        });

        function logout() {
            // Disable auto mode before logout
            if (autoModeEnabled) {
                toggleAutoMode();
            }
            auth.signOut().then(() => {
                showNotification('Logged out successfully', 'success');
            });
        }

        // Tab Management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            // Reset all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-yellow-600', 'text-white');
                btn.classList.add('bg-gray-700', 'text-gray-300');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.remove('hidden');

            // Highlight selected tab button
            event.target.closest('button').classList.remove('bg-gray-700', 'text-gray-300');
            event.target.closest('button').classList.add('bg-yellow-600', 'text-white');

            // Load tab-specific data
            if (tabName === 'live-stats') {
                loadGameHistory();
            }
        }

        // Game Control Functions
        function startBetting() {
            if (autoModeEnabled) {
                showNotification('Cannot start manual betting while AI mode is active!', 'error');
                return;
            }

            const timerInput = document.getElementById('gameTimer');
            const seconds = parseInt(timerInput.value) || 60;
            
            if (seconds < 10 || seconds > 300) {
                showNotification('Timer must be between 10-300 seconds', 'error');
                return;
            }

            currentGameId = Date.now().toString();
            
            // Update game state in Firebase
            database.ref('gameState').set({
                status: 'betting',
                timeLeft: seconds,
                gameId: currentGameId,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            // Reset bets
            database.ref('currentBets').remove();
            
            startCountdown(seconds);
            showNotification('Betting started!', 'success');
        }

        function startCountdown(seconds) {
            let timeLeft = seconds;
            
            const updateDisplay = () => {
                const minutes = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                document.getElementById('countdownDisplay').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                // Update game phase
                const phaseElement = document.getElementById('gamePhase');
                const statusElement = document.getElementById('gameStatus');
                
                if (timeLeft > 0) {
                    phaseElement.textContent = autoModeEnabled ? 'AI Betting Active' : 'Betting Active';
                    phaseElement.className = 'text-lg text-green-400';
                    statusElement.textContent = 'Betting';
                    statusElement.className = 'text-lg font-bold text-green-400';
                } else {
                    phaseElement.textContent = autoModeEnabled ? 'AI Processing Result...' : 'Betting Closed';
                    phaseElement.className = 'text-lg text-red-400';
                    statusElement.textContent = 'Waiting Result';
                    statusElement.className = 'text-lg font-bold text-yellow-400';
                }

                // Update Firebase
                database.ref('gameState/timeLeft').set(timeLeft);
            };

            updateDisplay();
            
            countdownInterval = setInterval(() => {
                timeLeft--;
                updateDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    database.ref('gameState/status').set('waiting_result');
                    
                    if (autoModeEnabled) {
                        setTimeout(() => {
                            calculateAutoResult();
                        }, 2000);
                    }
                }
            }, 1000);
        }

        function resetGame() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            if (autoModeTimeout) {
                clearTimeout(autoModeTimeout);
            }
            
            document.getElementById('countdownDisplay').textContent = '00:00';
            document.getElementById('gamePhase').textContent = 'Waiting to Start';
            document.getElementById('gamePhase').className = 'text-lg text-gray-300';
            
            const statusElement = document.getElementById('gameStatus');
            statusElement.textContent = 'Ready';
            statusElement.className = 'text-lg font-bold text-green-400';
            
            // Reset Firebase game state
            database.ref('gameState').set({
                status: 'ready',
                timeLeft: 0,
                gameId: null,
                result: null
            });
            
            database.ref('currentBets').remove();
            currentGameId = null;
            showNotification('Game reset successfully!', 'success');
        }

        function setResult(result) {
            if (!currentGameId) {
                showNotification('No active game!', 'error');
                return;
            }

            if (autoModeEnabled) {
                showNotification('Cannot set manual result while AI mode is active!', 'error');
                return;
            }

            // Set result in Firebase
            database.ref('gameState').update({
                status: 'result',
                result: result,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            // Process bets and update wallets instantly
            processBetsResult(result);

            // Save game to history
            saveGameHistory(result);

            showNotification(`Result set: ${result.toUpperCase()}`, 'success');

            // Reset after 5 seconds
            setTimeout(() => {
                resetGame();
            }, 5000);
        }

        async function processBetsResult(result) {
            try {
                const betsSnapshot = await database.ref('currentBets').once('value');
                const bets = betsSnapshot.val() || {};

                for (const [userId, betData] of Object.entries(bets)) {
                    let winAmount = 0;
                    
                    if (result === 'burn') {
                        // Burn coin - return original bet amount (no profit, no loss)
                        winAmount = betData.amount;
                    } else if (betData.choice === result) {
                        // Win - 2x the bet amount (double profit)
                        winAmount = betData.amount * 2;
                    }
                    // If winAmount is 0, user loses (bet amount already deducted)

                    if (winAmount > 0) {
                        // Update user wallet instantly
                        const userBalanceRef = database.ref(`users/${userId}/balance`);
                        const balanceSnapshot = await userBalanceRef.once('value');
                        const currentBalance = balanceSnapshot.val() || 0;
                        await userBalanceRef.set(currentBalance + winAmount);
                    }

                    // Update user statistics
                    const userRef = database.ref(`users/${userId}`);
                    const userSnapshot = await userRef.once('value');
                    const userData = userSnapshot.val() || {};

                    const updates = {};
                    if (winAmount > betData.amount) {
                        // User won
                        updates.totalProfit = (userData.totalProfit || 0) + (winAmount - betData.amount);
                    } else if (winAmount === 0) {
                        // User lost
                        updates.totalLoss = (userData.totalLoss || 0) + betData.amount;
                    }
                    // If winAmount === betData.amount, it's a burn (no profit, no loss)

                    if (Object.keys(updates).length > 0) {
                        await userRef.update(updates);
                    }
                }
            } catch (error) {
                console.error('Error processing bets:', error);
                showNotification('Error processing bets: ' + error.message, 'error');
            }
        }

        function saveGameHistory(result) {
            const historyRef = database.ref('gameHistory').push();
            
            database.ref('currentBets').once('value').then((snapshot) => {
                const bets = snapshot.val() || {};
                
                historyRef.set({
                    gameId: currentGameId,
                    result: result,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    bets: bets,
                    totalBets: Object.keys(bets).length,
                    totalAmount: Object.values(bets).reduce((sum, bet) => sum + bet.amount, 0),
                    aiGenerated: autoModeEnabled
                });
            });
        }

        // Enhanced AI Auto Mode
        function toggleAutoMode() {
            autoModeEnabled = !autoModeEnabled;
            const btn = document.getElementById('autoModeBtn');
            const aiIndicator = document.getElementById('aiStatusIndicator');
            const startBettingBtn = document.getElementById('startBettingBtn');
            const manualButtons = [
                document.getElementById('manualHeadsBtn'),
                document.getElementById('manualTailsBtn'),
                document.getElementById('manualBurnBtn')
            ];
            
            if (autoModeEnabled) {
                btn.innerHTML = '<i class="fas fa-robot mr-2"></i>Disable Auto Mode';
                btn.classList.add('auto-mode-active');
                aiIndicator.classList.remove('hidden');
                
                // Disable manual controls
                startBettingBtn.disabled = true;
                startBettingBtn.classList.add('opacity-50', 'cursor-not-allowed');
                manualButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                });
                
                showNotification('AI Auto Mode enabled - Starting continuous game cycle!', 'success');
                
                // Start the AI cycle immediately
                startAICycle();
                
            } else {
                btn.innerHTML = '<i class="fas fa-robot mr-2"></i>Enable Auto Mode';
                btn.classList.remove('auto-mode-active');
                aiIndicator.classList.add('hidden');
                
                // Re-enable manual controls
                startBettingBtn.disabled = false;
                startBettingBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                manualButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                });
                
                // Clear any ongoing AI timeouts
                if (autoModeTimeout) {
                    clearTimeout(autoModeTimeout);
                }
                
                showNotification('AI Auto Mode disabled', 'success');
                resetGame();
            }
        }

        function startAICycle() {
            if (!autoModeEnabled) return;
            
            const timerInput = document.getElementById('gameTimer');
            const seconds = parseInt(timerInput.value) || 60;
            
            // Generate new game ID
            currentGameId = Date.now().toString();
            
            // Update game state in Firebase
            database.ref('gameState').set({
                status: 'betting',
                timeLeft: seconds,
                gameId: currentGameId,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            // Reset bets
            database.ref('currentBets').remove();
            
            // Start countdown
            startCountdown(seconds);
        }

        async function calculateAutoResult() {
            if (!autoModeEnabled) return;
            
            try {
                const betsSnapshot = await database.ref('currentBets').once('value');
                const bets = betsSnapshot.val() || {};

                let headAmount = 0, tailAmount = 0;
                
                Object.values(bets).forEach(bet => {
                    if (bet.choice === 'heads') headAmount += bet.amount;
                    else if (bet.choice === 'tails') tailAmount += bet.amount;
                });

                let result;
                
                // AI Logic: Side with LESS money wins (kam rupye wala win kare)
                if (headAmount === tailAmount) {
                    result = 'burn';
                } else if (headAmount < tailAmount) {
                    result = 'heads'; // Less money on heads, so heads wins
                } else {
                    result = 'tails'; // Less money on tails, so tails wins
                }

                // Set result in Firebase
                database.ref('gameState').update({
                    status: 'result',
                    result: result,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });

                // Process bets and update wallets
                await processBetsResult(result);

                // Save game to history
                saveGameHistory(result);

                // Update UI to show result
                const phaseElement = document.getElementById('gamePhase');
                const statusElement = document.getElementById('gameStatus');
                
                phaseElement.textContent = `Result: ${result.toUpperCase()}`;
                phaseElement.className = 'text-lg text-yellow-400';
                statusElement.textContent = 'Result';
                statusElement.className = 'text-lg font-bold text-yellow-400';

                showNotification(`AI Result: ${result.toUpperCase()} (â‚¹${headAmount} vs â‚¹${tailAmount})`, 'success');

                // Wait 3 seconds then start next cycle
                autoModeTimeout = setTimeout(() => {
                    if (autoModeEnabled) {
                        resetGameForNextCycle();
                        autoModeTimeout = setTimeout(() => {
                            startAICycle();
                        }, 1000); // 1 second pause between games
                    }
                }, 3000);

            } catch (error) {
                console.error('Auto result calculation error:', error);
                showNotification('AI Error: ' + error.message, 'error');
                
                // Fallback and continue cycle
                if (autoModeEnabled) {
                    autoModeTimeout = setTimeout(() => {
                        startAICycle();
                    }, 5000);
                }
            }
        }

        function resetGameForNextCycle() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            document.getElementById('countdownDisplay').textContent = '00:00';
            document.getElementById('gamePhase').textContent = 'Preparing Next Round...';
            document.getElementById('gamePhase').className = 'text-lg text-blue-400';
            
            const statusElement = document.getElementById('gameStatus');
            statusElement.textContent = 'AI Active';
            statusElement.className = 'text-lg font-bold text-red-400';
            
            // Reset Firebase game state
            database.ref('gameState').set({
                status: 'ready',
                timeLeft: 0,
                gameId: null,
                result: null
            });
            
            database.ref('currentBets').remove();
            currentGameId = null;
        }

        // Boss Management (existing functions remain the same)
        async function handleBossSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('bossName').value.trim();
            const referralId = document.getElementById('bossReferralId').value.trim();

            if (!name || !referralId) {
                showNotification('Please fill all fields', 'error');
                return;
            }

            try {
                await database.ref('bosses').push({
                    name: name,
                    referralId: referralId,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });

                clearBossForm();
                showNotification('Boss added successfully!', 'success');
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        function clearBossForm() {
            document.getElementById('bossName').value = '';
            document.getElementById('bossReferralId').value = '';
        }

        async function loadBossList() {
            try {
                database.ref('bosses').on('value', (snapshot) => {
                    const bosses = snapshot.val() || {};
                    const bossList = document.getElementById('bossList');
                    const bossSelect = document.getElementById('bossSelect');
                    
                    bossList.innerHTML = '';
                    bossSelect.innerHTML = '<option value="">Select a boss</option>';
                    
                    Object.entries(bosses).forEach(([bossId, boss]) => {
                        // Boss list item
                        const bossElement = document.createElement('div');
                        bossElement.className = 'bg-gray-700 rounded-lg p-4 flex justify-between items-center';
                        bossElement.innerHTML = `
                            <div>
                                <h3 class="font-semibold text-white">${boss.name}</h3>
                                <p class="text-sm text-gray-400">ID: ${boss.referralId}</p>
                            </div>
                            <button onclick="deleteBoss('${bossId}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                        bossList.appendChild(bossElement);

                        // Boss select option
                        const option = document.createElement('option');
                        option.value = boss.referralId;
                        option.textContent = boss.name;
                        bossSelect.appendChild(option);
                    });

                    // Update total bosses count
                    document.getElementById('totalBosses').textContent = Object.keys(bosses).length;
                });
            } catch (error) {
                console.error('Error loading bosses:', error);
            }
        }

        async function deleteBoss(bossId) {
            if (confirm('Are you sure you want to delete this boss?')) {
                try {
                    await database.ref('bosses/' + bossId).remove();
                    showNotification('Boss deleted successfully!', 'success');
                } catch (error) {
                    showNotification('Error deleting boss: ' + error.message, 'error');
                }
            }
        }

        function handleBossSelect(e) {
            const referralId = e.target.value;
            if (referralId) {
                loadBossUsers(referralId);
            } else {
                document.getElementById('bossUsersList').innerHTML = '';
            }
        }

        function loadBossUsers(referralId) {
            database.ref('users').orderByChild('referredBy').equalTo(referralId).on('value', (snapshot) => {
                const users = snapshot.val() || {};
                const bossUsersList = document.getElementById('bossUsersList');
                
                bossUsersList.innerHTML = '';
                
                Object.entries(users).forEach(([userId, user]) => {
                    const userElement = document.createElement('div');
                    userElement.className = 'bg-gray-700 rounded-lg p-4';
                    userElement.innerHTML = `
                        <div class="flex items-center mb-2">
                            <div class="w-3 h-3 ${user.isOnline ? 'bg-green-500' : 'bg-gray-500'} rounded-full mr-2"></div>
                            <h3 class="font-semibold text-white">${user.name}</h3>
                        </div>
                        <div class="text-sm text-gray-300 space-y-1">
                            <div>Balance: â‚¹${user.balance || 0}</div>
                            <div class="text-green-400">Profit: â‚¹${user.totalProfit || 0}</div>
                            <div class="text-red-400">Loss: â‚¹${user.totalLoss || 0}</div>
                            <div class="text-gray-400">Joined: ${user.joinedAt ? new Date(user.joinedAt).toLocaleDateString() : 'N/A'}</div>
                        </div>
                    `;
                    bossUsersList.appendChild(userElement);
                });
            });
        }

        // Dashboard Data Loading
        function loadDashboardData() {
            // Load total users
            database.ref('users').on('value', (snapshot) => {
                const users = snapshot.val() || {};
                document.getElementById('totalUsers').textContent = Object.keys(users).length;
            });
        }

        function startRealTimeUpdates() {
            // Listen to current bets
            database.ref('currentBets').on('value', (snapshot) => {
                const bets = snapshot.val() || {};
                let headAmount = 0, tailAmount = 0, headCount = 0, tailCount = 0;

                Object.values(bets).forEach(bet => {
                    if (bet.choice === 'heads') {
                        headAmount += bet.amount;
                        headCount++;
                    } else if (bet.choice === 'tails') {
                        tailAmount += bet.amount;
                        tailCount++;
                    }
                });

                // Update UI
                document.getElementById('headBetsAmount').textContent = 'â‚¹' + headAmount;
                document.getElementById('tailBetsAmount').textContent = 'â‚¹' + tailAmount;
                document.getElementById('headBetsCount').textContent = headCount + ' users';
                document.getElementById('tailBetsCount').textContent = tailCount + ' users';
                document.getElementById('totalBetAmount').textContent = 'â‚¹' + (headAmount + tailAmount);
                document.getElementById('totalActiveUsers').textContent = (headCount + tailCount);
                document.getElementById('activeBets').textContent = 'â‚¹' + (headAmount + tailAmount);

                // Update chart
                updateLiveChart(headAmount, tailAmount);
            });
        }

        function loadGameHistory() {
            database.ref('gameHistory').orderByChild('timestamp').limitToLast(20).on('value', (snapshot) => {
                const history = snapshot.val() || {};
                const gameHistory = document.getElementById('gameHistory');
                
                gameHistory.innerHTML = '';
                
                Object.entries(history).reverse().forEach(([gameId, game]) => {
                    const gameElement = document.createElement('div');
                    gameElement.className = 'bg-gray-700 rounded-lg p-4';
                    
                    const resultColor = game.result === 'heads' ? 'text-yellow-400' : 
                                      game.result === 'tails' ? 'text-gray-400' : 'text-red-400';
                    
                    const aiLabel = game.aiGenerated ? '<span class="bg-red-500 text-white px-2 py-1 rounded text-xs">AI</span>' : '';
                    
                    gameElement.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-white font-semibold">Game ${game.gameId}</span>
                                ${aiLabel}
                            </div>
                            <span class="${resultColor} font-bold">${game.result?.toUpperCase()}</span>
                        </div>
                        <div class="text-sm text-gray-300">
                            <div>Total Bets: ${game.totalBets || 0}</div>
                            <div>Total Amount: â‚¹${game.totalAmount || 0}</div>
                            <div>Time: ${game.timestamp ? new Date(game.timestamp).toLocaleString() : 'N/A'}</div>
                        </div>
                    `;
                    gameHistory.appendChild(gameElement);
                });
            });
        }

        function loadWalletRequests() {
            database.ref('walletRequests').on('value', (snapshot) => {
                const requests = snapshot.val() || {};
                const walletRequestsList = document.getElementById('walletRequestsList');
                
                walletRequestsList.innerHTML = '';
                
                Object.entries(requests).forEach(([requestId, request]) => {
                    const requestElement = document.createElement('div');
                    requestElement.className = 'bg-gray-700 rounded-lg p-4 flex justify-between items-center';
                    
                    const statusColor = request.status === 'approved' ? 'text-green-400' : 
                                       request.status === 'rejected' ? 'text-red-400' : 'text-yellow-400';
                    
                    requestElement.innerHTML = `
                        <div>
                            <h3 class="font-semibold text-white">${request.userName || 'Unknown User'}</h3>
                            <p class="text-sm text-gray-400">Type: ${request.type}</p>
                            <p class="text-sm text-gray-400">Amount: â‚¹${request.amount}</p>
                            <p class="text-sm ${statusColor}">Status: ${request.status}</p>
                        </div>
                        <div class="space-x-2">
                            ${request.status === 'pending' ? `
                                <button onclick="approveRequest('${requestId}')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button onclick="rejectRequest('${requestId}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                        </div>
                    `;
                    walletRequestsList.appendChild(requestElement);
                });
            });
        }

        async function approveRequest(requestId) {
            try {
                const requestSnapshot = await database.ref('walletRequests/' + requestId).once('value');
                const request = requestSnapshot.val();
                
                if (request && request.status === 'pending') {
                    if (request.type === 'add_money') {
                        // Add money to user balance
                        const userBalanceRef = database.ref('users/' + request.userId + '/balance');
                        const balanceSnapshot = await userBalanceRef.once('value');
                        const currentBalance = balanceSnapshot.val() || 0;
                        await userBalanceRef.set(currentBalance + request.amount);
                    } else if (request.type === 'withdraw') {
                        // Money already deducted, just approve
                        // Additional withdrawal processing can be added here
                    }
                    
                    // Update request status
                    await database.ref('walletRequests/' + requestId + '/status').set('approved');
                    showNotification('Request approved successfully!', 'success');
                }
            } catch (error) {
                showNotification('Error approving request: ' + error.message, 'error');
            }
        }

        async function rejectRequest(requestId) {
            try {
                const requestSnapshot = await database.ref('walletRequests/' + requestId).once('value');
                const request = requestSnapshot.val();
                
                if (request && request.status === 'pending') {
                    if (request.type === 'withdraw') {
                        // Return money to user balance for withdrawal rejection
                        const userBalanceRef = database.ref('users/' + request.userId + '/balance');
                        const balanceSnapshot = await userBalanceRef.once('value');
                        const currentBalance = balanceSnapshot.val() || 0;
                        await userBalanceRef.set(currentBalance + request.amount);
                    }
                    
                    // Update request status
                    await database.ref('walletRequests/' + requestId + '/status').set('rejected');
                    showNotification('Request rejected!', 'success');
                }
            } catch (error) {
                showNotification('Error rejecting request: ' + error.message, 'error');
            }
        }

        // Initialize Charts
        function initializeCharts() {
            // Live Chart
            const liveCtx = document.getElementById('liveChart').getContext('2d');
            liveChart = new Chart(liveCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Heads Bets', 'Tails Bets'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#3B82F6', '#8B5CF6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#D1D5DB'
                            }
                        }
                    }
                }
            });

            // User Stats Chart
            const userStatsCtx = document.getElementById('userStatsChart').getContext('2d');
            userStatsChart = new Chart(userStatsCtx, {
                type: 'bar',
                data: {
                    labels: ['Total Users', 'Active Users', 'Total Bosses'],
                    datasets: [{
                        label: 'Count',
                        data: [0, 0, 0],
                        backgroundColor: ['#3B82F6', '#10B981', '#F59E0B'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#D1D5DB'
                            },
                            grid: {
                                color: '#374151'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#D1D5DB'
                            },
                            grid: {
                                color: '#374151'
                            }
                        }
                    }
                }
            });
        }

        function updateLiveChart(headAmount, tailAmount) {
            if (liveChart) {
                liveChart.data.datasets[0].data = [headAmount, tailAmount];
                liveChart.update();
            }
        }
    </script>
</body>
</html>
